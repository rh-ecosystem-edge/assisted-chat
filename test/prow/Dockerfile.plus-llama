# CI-only Dockerfile to build lightspeed-stack-plus-llama using the pipeline-built parent
FROM lightspeed-stack

USER root

# Add llama-stack sources from the repository root context
ADD ./llama-stack /app-root/llama-stack

# Ensure pip and install editable llama-stack plus project deps
RUN python3.12 -m ensurepip
RUN cd /app-root/llama-stack && python3.12 -m pip install --editable .
RUN cd /app-root/ && python3.12 -m pip install .

RUN microdnf install -y patch

# Patch created based on https://github.com/llamastack/llama-stack/pull/3957
COPY  llama-stack-make-tool-call-args-fully-recursive.patch /tmp/
RUN cat /tmp/llama-stack-make-tool-call-args-fully-recursive.patch \
  | patch -p1 -d "$(dirname "$(dirname "$(python3.12 -c "import llama_stack; print(llama_stack.__file__)")")")"

# Patch to add required and default parameters to MCP tool definitions
COPY  llama-stack-mcp-tool-params.patch /tmp/
RUN cat /tmp/llama-stack-mcp-tool-params.patch \
  | patch -p1 -d "$(dirname "$(dirname "$(python3.12 -c "import llama_stack; print(llama_stack.__file__)")")")"

USER 1001
EXPOSE 8080
