FROM quay.io/redhat-services-prod/assisted-installer-tenant/saas/assisted-chat-rag@sha256:39edcb0c36c3f0140acd2dfe5d0545dfbc3fb2e20e481b266aaf8dd962275af4 AS rag
# vim: set filetype=dockerfile
# This is the digest of quay.io/lightspeed-core/lightspeed-stack:0.3.1
FROM quay.io/lightspeed-core/lightspeed-stack@sha256:2f0ffece8209d763a50a0e49f57b8c372967551fbf821c735a5daf007139b66a

USER root

RUN microdnf install -y patch

# Patch created based on https://github.com/llamastack/llama-stack/pull/3957
COPY  llama-stack-make-tool-call-args-fully-recursive.patch /tmp/
RUN cat /tmp/llama-stack-make-tool-call-args-fully-recursive.patch \
  | patch -p1 -d "$(dirname "$(dirname "$(python3.12 -c "import llama_stack; print(llama_stack.__file__)")")")"

# Patch to add required and default parameters to MCP tool definitions
COPY  llama-stack-mcp-tool-params.patch /tmp/
RUN cat /tmp/llama-stack-mcp-tool-params.patch \
  | patch -p1 -d "$(dirname "$(dirname "$(python3.12 -c "import llama_stack; print(llama_stack.__file__)")")")"

COPY migrate.py /app/migrate.py
COPY --chown=1001:1001 --from=rag /all-mpnet-base-v2/ /app-root/all-mpnet-base-v2/
COPY --chown=1001:1001 --chmod=666 --from=rag /llama_stack_vector_db/faiss_store.db /llama_stack_vector_db/faiss_store.db
RUN chmod 777 /llama_stack_vector_db/

ENTRYPOINT ["/bin/sh", "-c", "python3.12 /app/migrate.py && python3.12 src/lightspeed_stack.py"]


USER 1001

EXPOSE 8080

LABEL com.redhat.component="assisted-chat" \
      name="assisted-chat" \
      description="Chat application for OpenShift Assisted Installer" \
      io.k8s.description="Chat application for OpenShift Assisted Installer" \
      distribution-scope="public" \
      release="main" \
      version="latest" \
      url="https://github.com/rh-ecosystem-edge/assisted-chat" \
      vendor="Red Hat, Inc."
